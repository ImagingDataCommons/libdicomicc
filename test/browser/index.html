<!--
Copyright (c)
-->
<!DOCTYPE HTML>
<html>
<head>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script type="text/javascript" src="../../dist/libiccjs.js"></script>
    <script type="text/javascript" src="../../dist/libiccwasm.js"></script>
    <script type="text/javascript" src="https://unpkg.com/dcmjs"></script>
</head>
<body>
<div class="container">
    <div class="page-header">
        <h1>ICC with WebAssembly</h1>
        <p class="lead">
          Select an image.
      </p>
      <div class="row">
        <select id="imageSelector">
          <option value="../../test/fixtures/test.dcm" selected>test</option>
        </select>
        <button id="benchmark">Benchmark</button>
        <label><input id="useWASM" disabled type="checkbox" value="">Use WASM</label>
      </div>
    </div>
    <div class="row">
      <div class="col-md-12">
      <b>Image Properties</b>
    </div>
  </div>
  <div class="row">
      <div class="col-md-4">Transform Time: <span id="transformTime"></span></div>
      <div class="col-md-4">Display Time: <span id="displayTime"></span></div>
    </div>
    <div class="row">
      <div class="col-md-4">Size: <span id="size"></span></div>
      <div class="col-md-4">Bits Per Sample: <span id="bitsPerSample"></span></div>
      <div class="col-md-4">Component Count: <span id="componentCount"></span></div>
    </div>
    <hr>
    <div class="row">
      <div class="col-md-6">
        <canvas id='myCanvas' width="512" height="512"/>
    </div>
  </div>
</body>

<script>
  let icctramsform = undefined;
  let icctramsformjs = undefined;
  let icctramsformwasm = undefined;

  let inputBitStream = undefined;
  let iccBitStream = undefined;
  let frameInfoImage = undefined;
  let planarConfiguration = undefined;

  function colorToCanvas(frameInfo, pixelData, imageData) {
    let outOffset = 0;
    const bytesPerSample = (frameInfo.bitsPerSample <= 8) ? 1 : 2;
    let shift = 0;
    if(frameInfo.bitsPerSample > 8) {
      shift = 8;
    }
    let inOffset = 0;

    for(var y=0; y < frameInfo.height; y++) {
      for (var x = 0; x < frameInfo.width; x++) {
        imageData.data[outOffset++] = pixelData[inOffset++] >> shift;
        imageData.data[outOffset++] = pixelData[inOffset++] >> shift;
        imageData.data[outOffset++] = pixelData[inOffset++] >> shift;
        imageData.data[outOffset++] = 255;
      }
    }
  }

  function display(pixelData) {
    const begin = performance.now(); // performance.now() returns value in milliseconds

    var c = document.getElementById("myCanvas");
    var ctx = c.getContext("2d");

    c.width = frameInfoImage.width;
    c.height = frameInfoImage.height;

    var myImageData = ctx.createImageData(frameInfoImage.width, frameInfoImage.height);
    colorToCanvas(frameInfoImage, pixelData, myImageData);
    ctx.putImageData(myImageData, 0, 0);

    const end = performance.now();
    $('#displayTime').text((end-begin).toFixed(2) + ' ms');
  }

  function transform() {
    let begin = performance.now(); // performance.now() returns value in milliseconds

    // Setup
    const inputBuffer = icctramsform.getInputBuffer(inputBitStream.length);
    inputBuffer.set(inputBitStream);

    const iccBuffer = icctramsform.getICCBuffer(iccBitStream.length);
    iccBuffer.set(iccBitStream);

    icctramsform.setFrameInfo(frameInfoImage)

    // transform
    icctramsform.transform();

    let end = performance.now();

    $('#transformTime').text((end-begin).toFixed(2) + ' ms');

    // Display image properties
    $('#size').text(''+frameInfoImage.width + 'x' + frameInfoImage.height);
    $('#bitsPerSample').text(''+frameInfoImage.bitsPerSample +' bpp ');
    $('#componentCount').text(''+frameInfoImage.componentCount);

    // Display Image
    const outputBuffer = icctramsform.getOutputBuffer();
    display(outputBuffer);
  }

  function loadArrayBuffer(arrayBuffer) {
    const dicomData = dcmjs.data.DicomMessage.readFile(arrayBuffer);
    const dataSet = dcmjs.data.DicomMetaDictionary.naturalizeDataset(dicomData.dict);
    dataSet._meta = dcmjs.data.DicomMetaDictionary.namifyDataset(dicomData.meta);

    const frameInfo = {
      width : dataSet.Columns,
      height : dataSet.Rows,
      bitsPerSample : dataSet.BitsAllocated,
      componentCount : dataSet.SamplesPerPixel,
      planarConfiguration : dataSet.PlanarConfiguration
    }

    frameInfoImage = frameInfo;

    iccBuffer = dataSet.OpticalPathSequence[0].ICCProfile[0];
    iccBitStream = new Uint8Array(dataSet.OpticalPathSequence[0].ICCProfile[0], 0 , iccBuffer.length);

    inputBitStream = new Uint8Array(dataSet.PixelData[0], 0, frameInfo.width * frameInfo.height * dataSet.SamplesPerPixel);

    display(inputBitStream)

    transform();
  }

  function load(url) {
    fetch(url)
    .then((response) => {
      return response.arrayBuffer();
    })
    .then((arrayBuffer) => {
      loadArrayBuffer(arrayBuffer);
    });
  }

  function reset() {
    const c = document.getElementById("myCanvas");
    const ctx = c.getContext("2d");
    ctx.fillRect(0,0,c.width, c.height);

    $('#transformTime').text('');
    $('#displayTime').text('');
  }

  function init(path) {
    $('#imageSelector').val(path);
    load(path);
  }

  function main() {
    init('../../test/fixtures/test.dcm');

    $('#imageSelector').change(function(e) {
      reset();
      load(e.target.options[e.target.selectedIndex].value);
    });

    $('#useWASM').change(function() {
      if (this.checked) {
        icctramsform = icctramsformwasm;
        transform();
      } else {
        icctramsform = icctramsformjs;
        transform();
      }
    });

    $('#benchmark').click(function(e) {
      setTimeout(() => {
        transform();
      }, 1);
    });
  }

  libicc().then(function(libiccjs) {
    console.log('libiccjs', libiccjs);
    icctramsformjs = new libiccjs.ICCCMSTransform();
    icctramsform = icctramsformjs;
    $('#useWASM').prop('checked', false);
    main();
  });

  libiccWASM().then(function(libiccwasm) {
    console.log('libiccwasm', libiccwasm);
    icctramsformwasm = new libiccwasm.ICCCMSTransform();
    icctramsform = icctramsformwasm;
    $('#useWASM').prop('checked', true);
    $('#useWASM').prop('disabled', false);
  });
</script>
</html>
